
# Warning: File generated from ci/appveyor.yml.in

version: 1.5.0.{build}

branches:
  only:
    - master
    - appveyor
    - v1.4-branch

configuration:
    - Release

platform:
    - x64

image: Visual Studio 2019

cache:
    - c:\tools\vcpkg\installed
    - c:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2

artifacts:
  - path: build/PhotoBroom-1.5.0-*.exe
    name: PhotoBroom_installer

environment:
    WINFLEXBISON_ARCHIVE: win_flex_bison3-latest.zip

install:
    - if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2"
        ( echo "CUDA dir exists" ) ELSE
        ( echo "Downloading CUDA binaries" &&
          mkdir "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2" &&
          curl -L -o "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2\cuda_x64.zip"
               https://www.dropbox.com/s/usjl5zfiha7e66s/cuda_x64.zip &&
          7z x "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2\cuda_x64.zip" -o"C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2\" )

    - cmd: echo set(VCPKG_BUILD_TYPE release) >> c:\tools\vcpkg\triplets\x64-windows.cmake
    - vcpkg --overlay-ports=./ci/vcpkg --overlay-ports=./ci/vcpkg-system-native install exiv2:x64-windows openlibrary:x64-windows dlib[core,cuda,fftw3]:x64-windows

before_build:
    - if not exist "%WINFLEXBISON_ARCHIVE%" appveyor DownloadFile "http://downloads.sourceforge.net/project/winflexbison/%WINFLEXBISON_ARCHIVE%"
    - 7z x -y -owinflexbison\ "%WINFLEXBISON_ARCHIVE%" > nul
    - set Path=%CD%\winflexbison;%Path%
    - win_flex --version
    - win_bison --version
    - cmd: cd %APPVEYOR_BUILD_FOLDER%
    - git submodule update --init --recursive
    - cmd: set generator="Visual Studio 16 2019"
    - cmd: set qt_arch=msvc2019_64
    - cmd: set arch=amd64
    - cmd: set USE_QT_VER=5.15
    - cmd: set PATH=C:\Qt\%USE_QT_VER%\%qt_arch%\bin;C:\Program Files\CMake\bin;%PATH%
    - cmd: set CMAKE_PREFIX_PATH=C:/Qt/%USE_QT_VER%/%qt_arch%;c:/projects/install
    - cmd: mkdir build
    - cmd: cd build
    - cmd: cmake -G%generator%
                 -A%platform%
                 -DBUILD_UPDATER=ON
                 -DBUILD_TESTING=OFF
                 -DPHOTO_BROOM_BUILD_ID=%APPVEYOR_BUILD_NUMBER%
                 -DCMAKE_TOOLCHAIN_FILE=C:\tools\vcpkg\scripts\buildsystems\vcpkg.cmake
                 -DLIBPATH_cublas64_11_Release="C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2\bin\cublas64_11.dll"
                 -DLIBPATH_cublasLt64_11_Release="C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.2\bin\cublasLt64_11.dll"
                 ..

build:
  project: build/PhotoBroom.sln
  parallel: true
  verbosity: minimal

after_build:
    - cmd: cmake --build . --target PACKAGE --config %configuration%
